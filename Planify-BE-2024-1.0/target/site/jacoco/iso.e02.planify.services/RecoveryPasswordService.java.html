<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="es"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>RecoveryPasswordService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">planify</a> &gt; <a href="index.source.html" class="el_package">iso.e02.planify.services</a> &gt; <span class="el_source">RecoveryPasswordService.java</span></div><h1>RecoveryPasswordService.java</h1><pre class="source lang-java linenums">package iso.e02.planify.services;

// imports de iso.e02.planify
import iso.e02.planify.entities.AppUser;
import iso.e02.planify.repositories.UsersRepository;

// imports de java
import java.util.HashMap;
import java.util.Map;
import java.util.Optional;
import java.util.UUID;

//imports de spring
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.HttpStatus;
import org.springframework.stereotype.Service;
import org.springframework.web.server.ResponseStatusException;

// imports de javax.mail
import javax.mail.MessagingException;

/**
 * Servicio para gestionar la recuperación de contraseñas de los usuarios.
 * Incluye la funcionalidad para enviar correos electrónicos de recuperación
 * y cambiar contraseñas.
 */
@Service
<span class="fc" id="L28">public class RecoveryPasswordService {</span>

<span class="fc" id="L30">    Map&lt;String, TokenPasswordChange&gt; tokens = new HashMap&lt;&gt;(); // contiene el token y el email del usuario</span>

    @Autowired
    private UsersRepository userRepository; // Inyección del repositorio de usuarios

    @Autowired
    private ValidateUserService validateUserService; // Inyección del servicio de validación de usuarios

    /**
     * Envía un correo electrónico de recuperación de contraseña al usuario con
     * el correo proporcionado, incluyendo un token único.
     *
     * @param email Dirección de correo electrónico a la que se enviará el
     *              correo de recuperación.
     * @return Mensaje confirmando que el correo ha sido enviado.
     */
    public String sendEmail(String email) {
        /**
         * Enviar email de recuperación de contraseña
         * enviamos un token al email que sera recibido en el cambio de contraseña
         * con esto nos aseguramos que el usuario que esta cambiando la contraseña es el
         * dueño de la cuenta
         */
<span class="fc" id="L53">        Optional&lt;AppUser&gt; optUser = userRepository.findByEmail(email);</span>
<span class="pc bpc" id="L54" title="1 of 2 branches missed.">        if (!optUser.isEmpty()) { // si existe el usuario o admin envia el email</span>
<span class="nc" id="L55">            String idToken = UUID.randomUUID().toString();</span>
<span class="nc" id="L56">            TokenPasswordChange token = new TokenPasswordChange(idToken, email);</span>
<span class="nc" id="L57">            this.tokens.put(idToken, token);</span>
<span class="nc" id="L58">            EmailSMTP smtp = new EmailSMTP();</span>
            try {
<span class="nc" id="L60">                smtp.sendEmail(email, idToken); // enviamos el email</span>
<span class="nc" id="L61">            } catch (MessagingException e) {</span>
<span class="nc" id="L62">                e.printStackTrace();</span>
<span class="nc" id="L63">            }</span>
        }
<span class="fc" id="L65">        return &quot;Email enviado, revise su bandeja de entrada y SPAM&quot;;</span>
    }

    /**
     * Cambia la contraseña del usuario asociado al correo electrónico proporcionado
     * utilizando el token de recuperación.
     *
     * @param email    Dirección de correo electrónico del usuario.
     * @param token    Token de recuperación enviado al correo electrónico.
     * @param password Nueva contraseña del usuario.
     * @return Mensaje confirmando que la contraseña ha sido cambiada con éxito.
     */
    public String changePassword(String email, String token, String password) {
<span class="fc" id="L78">        TokenPasswordChange tokenEmail = this.tokens.get(token); // token que se envio al email</span>
<span class="pc bpc" id="L79" title="2 of 6 branches missed.">        if (tokenEmail == null || !tokenEmail.getEmail().equals(email) || tokenEmail.isCaducado()) { // validar si el token no existe o no coincide con el email o esta caducado</span>
<span class="fc" id="L80">            throw new ResponseStatusException(HttpStatus.FORBIDDEN, &quot;Token inválido o caducado&quot;);</span>
        }
<span class="fc" id="L82">        Optional&lt;AppUser&gt; optUser = userRepository.findByEmail(email);</span>
<span class="fc bfc" id="L83" title="All 2 branches covered.">        if (optUser.isEmpty()) { // validar si el usuario no existe</span>
<span class="fc" id="L84">            throw new ResponseStatusException(HttpStatus.FORBIDDEN, &quot;El usuario no existe&quot;);</span>
        }
<span class="fc bfc" id="L86" title="All 2 branches covered.">        if (this.validateUserService.isPasswordSecure(password)) { // Comprobamos si la nueva contraseña cumple la política de contraseñas</span>
<span class="fc" id="L87">            AppUser user = optUser.get();</span>
<span class="fc" id="L88">            user.getCredentials().setPassword(this.validateUserService.hashPassword(password)); // Cambiamos la contraseña</span>
<span class="fc" id="L89">            userRepository.save(user); // Guardamos los cambios</span>
<span class="fc" id="L90">            tokens.remove(token); // Eliminamos el token</span>
<span class="fc" id="L91">        } else {</span>
<span class="fc" id="L92">            throw new ResponseStatusException(HttpStatus.FORBIDDEN, &quot;La contraseña no es segura&quot;);</span>
        }
<span class="fc" id="L94">        return &quot;Contraseña cambiada con exito&quot;;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>