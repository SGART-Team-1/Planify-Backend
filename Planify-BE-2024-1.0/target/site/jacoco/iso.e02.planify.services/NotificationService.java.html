<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="es"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>NotificationService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">planify</a> &gt; <a href="index.source.html" class="el_package">iso.e02.planify.services</a> &gt; <span class="el_source">NotificationService.java</span></div><h1>NotificationService.java</h1><pre class="source lang-java linenums">package iso.e02.planify.services;

import iso.e02.planify.entities.Notification;
import iso.e02.planify.entities.Meeting;
import iso.e02.planify.entities.CommonUser;
import iso.e02.planify.repositories.NotificationRepository;
import iso.e02.planify.repositories.MeetingRespository;
import iso.e02.planify.repositories.UsersRepository;
import iso.e02.planify.requests.NotificationDTO;
import iso.e02.planify.entities.MeetingAttendance;
import iso.e02.planify.entities.MeetingAttendance.InvitationStatus;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import java.time.LocalDateTime;
import java.util.List;
import java.util.UUID;
import java.util.stream.Collectors;

@Service
<span class="fc" id="L22">public class NotificationService {</span>

    @Autowired
    private NotificationRepository notificationRepository;

    @Autowired
    private MeetingRespository meetingRepository;

    @Autowired
    private UsersRepository usersRepository;

    /**
     * Crea una notificación cuando se invita a un usuario a una reunión.
     */
    public void createMeetingInvitationNotification(Long meetingId, Long userId, CommonUser authenticatedUser) {
<span class="nc" id="L37">        Meeting meeting = meetingRepository.findById(meetingId)</span>
<span class="nc" id="L38">                .orElseThrow(() -&gt; new IllegalArgumentException(&quot;Reunión no encontrada&quot;));</span>
    
<span class="nc" id="L40">        CommonUser invitedUser = (CommonUser) usersRepository.findById(userId)</span>
<span class="nc" id="L41">                .orElseThrow(() -&gt; new IllegalArgumentException(&quot;Usuario no encontrado&quot;));</span>
    
<span class="nc" id="L43">        String description = authenticatedUser.getName() + &quot; te ha invitado a una reunión: &quot; + meeting.getSubject() + &quot;.&quot;;</span>
    
<span class="nc" id="L45">        Notification notification = new Notification();</span>
<span class="nc" id="L46">        notification.setUser(invitedUser); // Destinatario</span>
<span class="nc" id="L47">        notification.setMeeting(meeting);</span>
<span class="nc" id="L48">        notification.setDescription(description);</span>
    
<span class="nc" id="L50">        notificationRepository.save(notification);</span>
<span class="nc" id="L51">    }</span>
    

    /**
     * Crea una notificación cuando un usuario acepta o rechaza una invitación.
     */
    public void createResponseNotification(Long meetingId, Long userId, MeetingAttendance.InvitationStatus status, String reason) {
<span class="nc" id="L58">        Meeting meeting = meetingRepository.findById(meetingId)</span>
<span class="nc" id="L59">                .orElseThrow(() -&gt; new IllegalArgumentException(&quot;Meeting not found&quot;));</span>
    
<span class="nc" id="L61">        CommonUser user = (CommonUser) usersRepository.findById(userId)</span>
<span class="nc" id="L62">                .orElseThrow(() -&gt; new IllegalArgumentException(&quot;User not found&quot;));</span>
    
<span class="nc" id="L64">        CommonUser organizer = meeting.getParticipants().stream()</span>
<span class="nc bnc" id="L65" title="All 2 branches missed.">                .filter(participant -&gt; participant.getRole() == MeetingAttendance.Role.ORGANIZADOR)</span>
<span class="nc" id="L66">                .map(MeetingAttendance::getUser)</span>
<span class="nc" id="L67">                .findFirst()</span>
<span class="nc" id="L68">                .orElseThrow(() -&gt; new IllegalArgumentException(&quot;Organizer not found for the meeting&quot;));</span>
    
        String description;
<span class="nc bnc" id="L71" title="All 2 branches missed.">        if (status == MeetingAttendance.InvitationStatus.ACEPTADA) {</span>
<span class="nc" id="L72">            description = user.getName() + &quot; ha aceptado tu invitación a la reunión &quot; + meeting.getSubject();</span>
<span class="nc bnc" id="L73" title="All 2 branches missed.">        } else if (status == MeetingAttendance.InvitationStatus.RECHAZADA) {</span>
<span class="nc" id="L74">            description = user.getName() + &quot; ha rechazado tu invitación a la reunión &quot; + meeting.getSubject();</span>
<span class="nc bnc" id="L75" title="All 4 branches missed.">            if (reason != null &amp;&amp; !reason.isBlank()) {</span>
<span class="nc" id="L76">                description += &quot; por motivo: &quot; + reason;</span>
            }
        } else {
<span class="nc" id="L79">            description = user.getName() + &quot; ha cambiado su estado de invitación a &quot; + status;</span>
        }
    
<span class="nc" id="L82">        Notification notification = new Notification();</span>
<span class="nc" id="L83">        notification.setUser(organizer); // Notificar al organizador</span>
<span class="nc" id="L84">        notification.setMeeting(meeting);</span>
<span class="nc" id="L85">        notification.setDescription(description);</span>
    
<span class="nc" id="L87">        notificationRepository.save(notification);</span>
<span class="nc" id="L88">    }</span>
    

    // Notificaciones de cancelación
    public void createCancellationNotifications(Long meetingId, CommonUser organizer) {
<span class="nc" id="L93">        Meeting meeting = meetingRepository.findById(meetingId)</span>
<span class="nc" id="L94">                .orElseThrow(() -&gt; new IllegalArgumentException(&quot;Meeting not found&quot;));</span>
    
        // Filtrar los participantes con estado ACEPTADA, excluyendo al organizador
<span class="nc" id="L97">        List&lt;MeetingAttendance&gt; acceptedParticipants = meeting.getParticipants().stream()</span>
<span class="nc bnc" id="L98" title="All 2 branches missed.">                .filter(attendance -&gt; attendance.getInvitationStatus() == InvitationStatus.ACEPTADA)</span>
<span class="nc bnc" id="L99" title="All 2 branches missed.">                .filter(attendance -&gt; !attendance.getUser().equals(organizer)) // Excluir al organizador</span>
<span class="nc" id="L100">                .toList();</span>
    
        // Crear notificaciones para los asistentes que aceptaron la reunión
<span class="nc bnc" id="L103" title="All 2 branches missed.">        for (MeetingAttendance attendance : acceptedParticipants) {</span>
<span class="nc" id="L104">            Notification notification = new Notification();</span>
<span class="nc" id="L105">            notification.setUser(attendance.getUser());</span>
<span class="nc" id="L106">            notification.setMeeting(meeting);</span>
<span class="nc" id="L107">            notification.setDescription(organizer.getName() + &quot; ha cancelado la reunión &quot; + meeting.getSubject() + &quot; que habías aceptado.&quot;);</span>
<span class="nc" id="L108">            notificationRepository.save(notification);</span>
<span class="nc" id="L109">        }</span>
<span class="nc" id="L110">    }</span>
    

    // Crear notificación para cuando un usuario asiste a una reunión
    public void createAssistanceNotification(Meeting meeting, CommonUser user) {
<span class="nc" id="L115">        CommonUser organizer = meeting.getParticipants().stream()</span>
<span class="nc bnc" id="L116" title="All 2 branches missed.">                .filter(participant -&gt; participant.getRole() == MeetingAttendance.Role.ORGANIZADOR)</span>
<span class="nc" id="L117">                .map(MeetingAttendance::getUser)</span>
<span class="nc" id="L118">                .findFirst()</span>
<span class="nc" id="L119">                .orElseThrow(() -&gt; new IllegalArgumentException(&quot;Organizador no encontrado para la reunión&quot;));</span>

<span class="nc" id="L121">        String description = user.getName() + &quot; ha asistido a la reunión &quot; + meeting.getSubject();</span>

<span class="nc" id="L123">        Notification notification = new Notification();</span>
<span class="nc" id="L124">        notification.setUser(organizer); // Notificar al organizador</span>
<span class="nc" id="L125">        notification.setMeeting(meeting);</span>
<span class="nc" id="L126">        notification.setDescription(description);</span>

<span class="nc" id="L128">        notificationRepository.save(notification);</span>
<span class="nc" id="L129">    }</span>

    /**
     * Recupera todas las notificaciones de un usuario.
     */
    public List&lt;NotificationDTO&gt; getNotificationsForUser(Long userId) {
        // Filtrar notificaciones por usuario y convertir a DTO
<span class="nc" id="L136">        return notificationRepository.findByUserId(userId)</span>
<span class="nc" id="L137">                .stream()</span>
<span class="nc" id="L138">                .map(notification -&gt; new NotificationDTO(</span>
<span class="nc" id="L139">                        notification.getNotificationId(),</span>
<span class="nc" id="L140">                        notification.getDescription(),</span>
<span class="nc" id="L141">                        notification.getReadingDate()</span>
                ))
<span class="nc" id="L143">                .collect(Collectors.toList());</span>
    }

    public void markAsRead(UUID notificationId) {
        // Buscar notificación y marcar como leída
<span class="nc" id="L148">        Notification notification = notificationRepository.findById(notificationId)</span>
<span class="nc" id="L149">                .orElseThrow(() -&gt; new IllegalArgumentException(&quot;Notification not found&quot;));</span>
<span class="nc" id="L150">        notification.setReadingDate(LocalDateTime.now());</span>
<span class="nc" id="L151">        notificationRepository.save(notification);</span>
<span class="nc" id="L152">    }</span>

    public void discard(UUID notificationId) {
        // Cambiar estado de la notificación a descartada
<span class="nc" id="L156">        Notification notification = notificationRepository.findById(notificationId)</span>
<span class="nc" id="L157">                .orElseThrow(() -&gt; new IllegalArgumentException(&quot;Notification not found&quot;));</span>
<span class="nc" id="L158">        notification.setState(true);</span>
<span class="nc" id="L159">        notificationRepository.save(notification);</span>
<span class="nc" id="L160">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>