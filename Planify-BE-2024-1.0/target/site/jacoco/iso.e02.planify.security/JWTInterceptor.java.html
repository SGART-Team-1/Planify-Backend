<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="es"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>JWTInterceptor.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">planify</a> &gt; <a href="index.source.html" class="el_package">iso.e02.planify.security</a> &gt; <span class="el_source">JWTInterceptor.java</span></div><h1>JWTInterceptor.java</h1><pre class="source lang-java linenums">package iso.e02.planify.security;

// imports de iso.e02.planify
import iso.e02.planify.entities.Administrator;
import iso.e02.planify.repositories.UsersRepository;
import iso.e02.planify.services.ValidateUserService;

// imports de java
import java.util.Arrays;

// imports de spring
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Component;
import org.springframework.util.AntPathMatcher;
import org.springframework.web.servlet.HandlerInterceptor;

// imports de jakarta
import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpServletResponse;

/**
 * Interceptor de Spring que se encarga de interceptar las peticiones HTTP y validar el token JWT.
 * 
 * Esta clase implementa la interfaz HandlerInterceptor de Spring, que define métodos que se ejecutan
 * antes y después de que se maneje una petición HTTP.
 * 
 * El método preHandle se ejecuta antes de que se maneje la petición HTTP. En este método se extrae el 
 * token JWT del encabezado Authorization, se valida y se comprueba si el usuario tiene permisos para acceder a la ruta solicitada.
 */
@Component
public class JWTInterceptor implements HandlerInterceptor {

    @Autowired
    private ValidateUserService validateUserService; // Inyección del servicio de validación de JWT

    @Autowired
    private UsersRepository usersRepository; // Inyección del repositorio de usuarios


<span class="fc" id="L40">    AntPathMatcher pathMatcher = new AntPathMatcher();</span>

<span class="fc" id="L42">    public JWTInterceptor(ValidateUserService validateUserService) { // Constructor de la clase</span>
<span class="fc" id="L43">        this.validateUserService = validateUserService;</span>
<span class="fc" id="L44">    }</span>

    /**
     * Método que se ejecuta antes de manejar la petición HTTP.
     * 
     * @param request  La petición HTTP.
     * @param response La respuesta HTTP.
     * @param handler  El controlador que manejará la petición.
     * @return true si la petición debe continuar, false si debe detenerse.
     * @throws Exception Si ocurre un error al manejar la petición.
     */
    @SuppressWarnings(&quot;null&quot;)
    @Override
    public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) throws Exception {
<span class="nc bnc" id="L58" title="All 2 branches missed.">        if (&quot;OPTIONS&quot;.equalsIgnoreCase(request.getMethod())) { // Skip `OPTIONS` requests</span>
<span class="nc" id="L59">            return true;</span>
        }
<span class="nc" id="L61">        String jwt = request.getHeader(&quot;Authorization&quot;); // Extraer el token JWT del encabezado Authorization</span>
<span class="nc bnc" id="L62" title="All 4 branches missed.">        if (jwt == null || !jwt.startsWith(&quot;Bearer &quot;)) { // Comprobar si el token JWT es nulo o no comienza con &quot;Bearer &quot;</span>
<span class="nc" id="L63">            response.sendError(HttpServletResponse.SC_UNAUTHORIZED, &quot;Authorization header is missing or invalid&quot;);</span>
<span class="nc" id="L64">            return false;</span>
        }
<span class="nc" id="L66">        jwt = jwt.replace(&quot;Bearer &quot;, &quot;&quot;); // Quitar el prefijo &quot;Bearer &quot; del token JWT</span>
        try {
<span class="nc" id="L68">            String email = validateUserService.validateJWT(jwt); // Validar el token JWT y extraer el email del usuario</span>
<span class="nc" id="L69">            String role = &quot;CommonUser&quot;;</span>
<span class="nc bnc" id="L70" title="All 2 branches missed.">            if (usersRepository.findByEmail(email).get() instanceof Administrator) { // Comprobar si el usuario es un administrador</span>
<span class="nc" id="L71">                role = &quot;Administrator&quot;;</span>
            }

            // Validar el acceso a los end points del back dependiendo del rol del usuario
<span class="nc" id="L75">            String requestPath = request.getRequestURI();</span>
<span class="nc" id="L76">            String[] adminRoutes = { // Rutas de administrador</span>
                &quot;/absences/*/delete&quot;,  
                &quot;/absences/create&quot;,     
                &quot;/workSchedule/addWorkSchedule&quot;,
                &quot;/api/administrators/**&quot;, 
                &quot;/api/users/showUsers&quot;,
                &quot;/api/users/*/block&quot;,
                &quot;/api/users/*/unblock&quot;,
                &quot;/api/users/*/activate&quot;,
                &quot;/api/users/registerUser&quot;,
                &quot;/absences/*/list&quot;, 
                &quot;/api/users/*/hasOpenedMeetings&quot;,
                &quot;/api/users/*&quot;,
                &quot;/absences/checkMeetingOverlap&quot; 
            };
            
<span class="nc" id="L92">            String[] commonUserRoutes = { // Rutas de usuario común</span>
                &quot;/meetings/**&quot;,          
                &quot;/absences/list&quot;       
            };
            
<span class="nc" id="L97">            String[] sharedRoutes = {</span>
                &quot;/api/users/*/inspect&quot;,
                &quot;/api/users/validateJWT&quot; // Rutas accesibles por ambos roles
            };

            // Validar rutas compartidas primero
<span class="nc bnc" id="L103" title="All 2 branches missed.">            if (Arrays.stream(sharedRoutes).anyMatch(route -&gt; pathMatcher.match(route, requestPath))) {</span>
<span class="nc" id="L104">                return true; // Permitir acceso a rutas compartidas</span>
            }
<span class="nc bnc" id="L106" title="All 4 branches missed.">            else if (Arrays.stream(adminRoutes).anyMatch(route -&gt; pathMatcher.match(route, requestPath)) &amp;&amp;  &quot;CommonUser&quot;.equals(role)) {</span>
<span class="nc" id="L107">                response.sendError(HttpServletResponse.SC_FORBIDDEN,</span>
                &quot;Acceso denegado, función solo disponible para administradores&quot;);
<span class="nc" id="L109">                return false;</span>

<span class="nc bnc" id="L111" title="All 4 branches missed.">            } else if (Arrays.stream(commonUserRoutes).anyMatch(route -&gt; pathMatcher.match(route, requestPath)) &amp;&amp; &quot;Administrator&quot;.equals(role)) {// funcionalidades de usuario común</span>
<span class="nc" id="L112">                response.sendError(HttpServletResponse.SC_FORBIDDEN,</span>
                        &quot;Acceso denegado, función solo disponible para usuarios comunes&quot;);
<span class="nc" id="L114">                return false;</span>
            } 
            else{
<span class="nc" id="L117">                return true; // Permitir acceso a rutas permitidas</span>
            }
<span class="nc" id="L119">        } catch (Exception e) {</span>
<span class="nc" id="L120">            response.sendError(HttpServletResponse.SC_UNAUTHORIZED, &quot;Invalid or expired JWT token&quot;); // Enviar un error 401 si el token JWT es inválido o ha expirado</span>
<span class="nc" id="L121">            return false;</span>
        }
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>